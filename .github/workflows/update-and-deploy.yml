name: Update Data and Deploy to GitHub Pages

on:
  # 6æ™‚é–“ã”ã¨ã«è‡ªå‹•å®Ÿè¡Œ (UTCæ™‚é–“)
  schedule:
    - cron: '0 */6 * * *'  # 00:00, 06:00, 12:00, 18:00 UTC
  
  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:
    inputs:
      force_full_update:
        description: 'Force full data refresh (ignore cache)'
        required: false
        default: 'false'
        type: boolean

# åŒæ™‚å®Ÿè¡Œã‚’é˜²ãï¼ˆãƒ‡ãƒ¼ã‚¿æ›´æ–°ã®ç«¶åˆã‚’é¿ã‘ã‚‹ï¼‰
concurrency:
  group: data-update
  cancel-in-progress: false

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360  # 6æ™‚é–“ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®š
    
    steps:
      # Phase 1: ç’°å¢ƒæº–å‚™
      - name: ğŸ“‚ Checkout repository
        uses: actions/checkout@v4
        with:
          # æ—¢å­˜ã®cache.jsonã‚’ä¿æŒã™ã‚‹ãŸã‚ã«fetch-depth: 0
          fetch-depth: 0

      - name: ğŸ“Š Debug - Repository state check
        run: |
          echo "=== Repository State ==="
          pwd
          ls -la
          echo "=== .git directory check ==="
          ls -la .git/ || echo "No .git directory found"
          echo "=== data directory check ==="
          ls -la data/ || echo "No data directory found"

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ğŸ“¦ Install dependencies
        run: |
          echo "=== Installing dependencies ==="
          npm ci
          echo "=== Dependency installation completed ==="

      # Phase 2: æ—¢å­˜ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã®ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—
      - name: ğŸ’¾ Backup existing cache
        run: |
          echo "=== Backup existing cache ==="
          if [ -f "data/cache.json" ]; then
            cp data/cache.json data/cache.backup.json
            echo "âœ… Existing cache backed up"
            echo "Cache file size: $(du -h data/cache.json)"
          else
            echo "âš ï¸ No existing cache found - first run"
          fi

      # Phase 3: ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
      - name: ğŸš€ Run build script
        env:
          RIOT_API_KEY: ${{ secrets.RIOT_API_KEY }}
          TARGET_REGION: jp1
          ACCOUNT_REGION: asia
          OUTPUT_DIR: .
          CACHE_DIR: ./data
          DEBUG_MODE: true
          FORCE_UPDATE: ${{ github.event.inputs.force_full_update || 'false' }}
        run: |
          echo "=== Starting build process ==="
          echo "Build started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # API ã‚­ãƒ¼ã®å­˜åœ¨ç¢ºèªï¼ˆå€¤ã¯è¡¨ç¤ºã—ãªã„ï¼‰
          if [ -z "$RIOT_API_KEY" ]; then
            echo "âŒ ERROR: RIOT_API_KEY is not set"
            exit 1
          else
            echo "âœ… RIOT_API_KEY is configured"
          fi
          
          # ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ç›£è¦–é–‹å§‹
          echo "=== System Resources ==="
          free -h
          df -h
          
          # ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
          node src/build.js --prod
          
          echo "Build completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      # Phase 4: ãƒ“ãƒ«ãƒ‰çµæœã®æ¤œè¨¼
      - name: ğŸ” Verify build results
        run: |
          echo "=== Build Verification ==="
          
          # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ç¢ºèª
          required_files=("index.html" "a-z.html" "z-a.html" "manifest.json" "sw.js" "data/cache.json")
          
          for file in "${required_files[@]}"; do
            if [ -f "$file" ]; then
              size=$(du -h "$file" | cut -f1)
              echo "âœ… $file exists (size: $size)"
            else
              echo "âŒ Missing required file: $file"
              exit 1
            fi
          done
          
          # HTMLãƒ•ã‚¡ã‚¤ãƒ«æ•°ç¢ºèª
          html_count=$(find . -maxdepth 1 -name "*.html" | wc -l)
          echo "ğŸ“„ Generated HTML files: $html_count"
          
          # ç”»åƒãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªç¢ºèª
          if [ -d "images" ]; then
            image_count=$(find images -name "*.jpg" -o -name "*.png" | wc -l)
            echo "ğŸ–¼ï¸ Downloaded images: $image_count"
          fi
          
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã®è©³ç´°
          if [ -f "data/cache.json" ]; then
            echo "=== Cache File Analysis ==="
            echo "Cache size: $(du -h data/cache.json)"
            echo "Cache line count: $(wc -l < data/cache.json)"
            
            # JSONã®å¦¥å½“æ€§ç¢ºèª
            if node -e "JSON.parse(require('fs').readFileSync('data/cache.json', 'utf8')); console.log('âœ… Cache JSON is valid')"; then
              echo "âœ… Cache file is valid JSON"
            else
              echo "âŒ Cache file is invalid JSON"
              exit 1
            fi
          fi

      # Phase 5: GitHub Pages ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: ğŸš€ Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        if: success()  # ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ãŸå ´åˆã®ã¿ãƒ‡ãƒ—ãƒ­ã‚¤
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          exclude_assets: |
            node_modules
            src
            templates
            .env*
            package*.json
            *.md
            data/cache.backup.json
          force_orphan: true
          enable_jekyll: false
          commit_message: |
            ğŸ¤– Auto-update: League of Legends counter data
            
            Updated at: ${{ steps.get-time.outputs.time }}
            Triggered by: ${{ github.event_name }}
            ğŸ”„ Data refresh completed successfully

      # Phase 6: ãƒ‡ãƒ—ãƒ­ã‚¤å¾Œã®é€šçŸ¥ã¨ã‚¯ãƒªãƒ¼ãƒ³ã‚¢ãƒƒãƒ—
      - name: ğŸ“ Generate deployment summary
        if: always()
        run: |
          echo "=== Deployment Summary ==="
          echo "Workflow: ${{ github.workflow }}"
          echo "Run ID: ${{ github.run_id }}"
          echo "Triggered by: ${{ github.event_name }}"
          echo "Repository: ${{ github.repository }}"
          echo "Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "âœ… Deployment completed successfully"
            echo "ğŸŒ Site will be available at: https://${{ github.repository_owner }}.github.io/FastestLOLCounterFinder"
          else
            echo "âŒ Deployment failed"
            echo "Please check the logs above for error details"
          fi
          
          # ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨é‡ã®æœ€çµ‚ç¢ºèª
          echo "=== Final System Resources ==="
          free -h
          df -h

      # Phase 7: ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±å‡ºåŠ›
      - name: ğŸ”§ Debug information on failure
        if: failure()
        run: |
          echo "=== DEBUG INFORMATION ==="
          echo "Working directory contents:"
          ls -la
          
          echo "=== data directory contents ==="
          ls -la data/ || echo "No data directory"
          
          echo "=== Logs from last 50 lines ==="
          tail -50 /tmp/* 2>/dev/null || echo "No log files found"
          
          echo "=== Environment variables (masked) ==="
          env | grep -E "(NODE|NPM|GITHUB)" | head -20
          
          echo "=== Process information ==="
          ps aux | head -20
          
          # ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‹ã‚‰å¾©æ—§ã‚’è©¦è¡Œ
          if [ -f "data/cache.backup.json" ]; then
            echo "=== Attempting cache recovery ==="
            cp data/cache.backup.json data/cache.json
            echo "âœ… Cache restored from backup"
          fi