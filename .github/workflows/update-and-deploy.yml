name: Update Data and Deploy to GitHub Pages

on:
  # 1æ—¥4å›žã®è‡ªå‹•å®Ÿè¡Œï¼ˆJST: 6:00, 12:00, 18:00, 24:00ï¼‰
  schedule:
    - cron: '0 21 * * *'  # JST 06:00 (UTC 21:00)
    - cron: '0 3 * * *'   # JST 12:00 (UTC 03:00)
    - cron: '0 9 * * *'   # JST 18:00 (UTC 09:00)
    - cron: '0 15 * * *'  # JST 24:00 (UTC 15:00)

  # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½ã«ã™ã‚‹
  workflow_dispatch:
    inputs:
      force_full_update:
        description: 'Force full data refresh (ignore cache)'
        required: false
        default: false
        type: boolean

# åŒæ™‚å®Ÿè¡Œã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¦ã€å¸¸ã«æœ€æ–°ã®1ã¤ã ã‘ãŒå®Ÿè¡Œã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: true

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    permissions:
      contents: write # git push ã¨ gh-pages ã¸ã®ãƒ‡ãƒ—ãƒ­ã‚¤ã«å¿…è¦

    steps:
      # 1. ç’°å¢ƒæº–å‚™
      - name: ðŸ“‚ Checkout repository
        uses: actions/checkout@v4
        with:
          # cache.jsonã‚’ã‚³ãƒŸãƒƒãƒˆã™ã‚‹ãŸã‚ã«ãƒªãƒã‚¸ãƒˆãƒªã®å…¨å±¥æ­´ã‚’å–å¾—
          fetch-depth: 0

      - name: ðŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: ðŸ“¦ Install dependencies
        run: npm ci

      # 2. ãƒ“ãƒ«ãƒ‰å®Ÿè¡Œ
      - name: ðŸš€ Run build script
        env:
          RIOT_API_KEY: ${{ secrets.RIOT_API_KEY }}
          TARGET_REGION: 'jp1'
          ACCOUNT_REGION: 'asia'
          OUTPUT_DIR: '.'
          CACHE_DIR: './data'
          DEBUG_MODE: false
          FORCE_UPDATE: ${{ github.event.inputs.force_full_update || 'false' }}
        run: |
          echo "Build started at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          node src/build.js --prod
          echo "Build completed at: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"

      # 3. ãƒ“ãƒ«ãƒ‰çµæžœã®æ¤œè¨¼
      - name: ðŸ” Verify build results
        id: build-stats
        run: |
          echo "Validating build architecture..."
          # å¿…é ˆãƒ•ã‚¡ã‚¤ãƒ«ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯
          REQUIRED_FILES=("index.html" "sw.js" "manifest.json" "data/cache.json")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "$file" ]; then
              echo "âŒ Critical file missing: $file"
              exit 1
            fi
            echo "âœ… Found required file: $file"
          done
          
          # ç”Ÿæˆãƒšãƒ¼ã‚¸æ•°ã‚«ã‚¦ãƒ³ãƒˆ
          HTML_COUNT=$(find . -maxdepth 1 -name "*.html" | wc -l)
          echo "pages-generated=$HTML_COUNT" >> $GITHUB_OUTPUT
          
          # ç”»åƒæ•°ã‚«ã‚¦ãƒ³ãƒˆ
          IMAGE_COUNT=$(find images -type f 2>/dev/null | wc -l || echo 0)
          echo "images-downloaded=$IMAGE_COUNT" >> $GITHUB_OUTPUT
          
          echo "ðŸ“Š Build statistics:"
          echo "  - HTML Pages: $HTML_COUNT"
          echo "  - Images: $IMAGE_COUNT"

      # 4. cache.jsonã¨HTMLãƒ•ã‚¡ã‚¤ãƒ«ã®å¤‰æ›´ã‚’ã‚³ãƒŸãƒƒãƒˆ
      - name: ðŸ’¾ Commit updated cache.json and HTML files
        id: commit-cache
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # å¤‰æ›´ãŒã‚ã‚‹ã‹ç¢ºèªï¼ˆcache.jsonã¾ãŸã¯HTMLãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
          if ! git diff --quiet data/cache.json || ! git diff --quiet -- '*.html' 'images/' 'manifest.json' 'sw.js'; then
            echo "âœ… Files have been updated. Committing changes..."
            git add data/cache.json *.html images/ manifest.json sw.js
            git commit -m "ðŸ¤– Auto-update: Refresh data and static files" -m "Triggered by: ${{ github.event_name }}"
            git push
            echo "commit-pushed=true" >> $GITHUB_OUTPUT
          else
            echo "â„¹ï¸ No changes detected in tracked files. Skipping commit."
            echo "commit-pushed=false" >> $GITHUB_OUTPUT
          fi

      # 5. GitHub Pages ã¸ãƒ‡ãƒ—ãƒ­ã‚¤
      - name: ðŸš€ Deploy to GitHub Pages
        if: steps.commit-cache.outputs.commit-pushed == 'true'
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: .
          # ãƒ‡ãƒ—ãƒ­ã‚¤ã«ä¸è¦ãªãƒ•ã‚¡ã‚¤ãƒ«ã‚’é™¤å¤–
          exclude_assets: |
            .github/
            node_modules/
            src/
            templates/
            .env*
            package*.json
            *.md
          force_orphan: true # å¸¸ã«ã‚¯ãƒªãƒ¼ãƒ³ãªçŠ¶æ…‹ã§ãƒ‡ãƒ—ãƒ­ã‚¤
          enable_jekyll: false
          commit_message: |
            ðŸ¤– Deploy: Update site content
            
            Timestamp: $(date -u '+%Y-%m-%d %H:%M:%S UTC')
            Triggered by: ${{ github.event_name }}
            Pages Generated: ${{ steps.build-stats.outputs.pages-generated }}
            Images: ${{ steps.build-stats.outputs.images-downloaded }}

      # 6. å®Œäº†é€šçŸ¥
      - name: âœ… Post-run summary
        if: always()
        run: |
          echo "### Workflow Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Status | **${{ job.status }}** |" >> $GITHUB_STEP_SUMMARY
          echo "|---|---|" >> $GITHUB_STEP_SUMMARY
          echo "| Trigger | ${{ github.event_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Pages Generated | ${{ steps.build-stats.outputs.pages-generated }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Images Downloaded | ${{ steps.build-stats.outputs.images-downloaded }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Cache Updated | ${{ steps.commit-cache.outputs.commit-pushed }} |" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ job.status }}" == "success" ]; then
            echo "ðŸŽ‰ Deployment completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "ðŸŒ Site is live at: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Deployment failed. Please check the logs for details." >> $GITHUB_STEP_SUMMARY
          fi